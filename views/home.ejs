<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FR360</title>
  <link rel="icon" type="image/png" href="/favicon.png?v=3" />
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
  <!-- Bot√≥n hamburguesa para m√≥vil -->
  <button id="menuToggle" aria-label="Abrir men√∫">‚ò∞</button>

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="logo">
      <img
        src="/fr360-logo.png"
        alt="FR360 Logo"
        class="logo-img"
      />
    </div>
    <nav>
      <ul>
        <li data-tab="comercialito" class="active">Comercialito</li>
        <li data-tab="membresias">Membres√≠as</li>
        <li data-tab="ventas">Ventas</li>
        <li data-tab="acuerdos">Acuerdos</li>
        <li data-tab="links">Links</li>
        <li class="nav-section-title">Utilidades</li>
        <li data-tab="webpig">Web Pig üê∑</li>
        <li data-tab="udea2026">Udea2026</li>
      </ul>
    </nav>
  </aside>

  <!-- MAIN -->
  <div id="main">
    <!-- TOPBAR -->
    <div id="topbar">
      <input type="text" id="searchId" placeholder="Ingrese Nro ID o correo‚Ä¶" />
      <button type="button" id="searchBtn">Buscar</button>
      <div id="statusTop"></div>
      <div id="currentUser" style="margin-left:auto; font-size:0.9em; color:#666;"></div>
    </div>

    <!-- CONTENT -->
    <div id="content">
      <!-- COMERCIALITO -->
      <div class="pane left active" id="comercialito">
        <div class="comercialito-layout">
          <!-- VENTA NORMAL (IZQUIERDA) -->
          <div class="venta-normal">
            <h3 style="margin-top: 0; margin-bottom: 20px; color: #075183;">Venta normal</h3>
            <div class="form-row">
              <span class="label">Nombres:</span>
              <input id="nombres" class="input gray"/>
            </div>
            <div class="form-row">
              <span class="label">Apellidos:</span>
              <input id="apellidos" class="input gray"/>
            </div>
            <div class="form-row">
              <span class="label">Correo:</span>
              <input id="correo" class="input" />
            </div>
            <div class="form-row">
              <span class="label">Celular:</span>
              <div class="input-wrapper">
                <input id="celular" class="input" />
                <span id="callbellIcon" class="callbell-icon" style="display:none;">üõéÔ∏è</span>
              </div>
            </div>
            <div class="form-row">
              <span class="label">Producto:</span>
              <input id="producto" class="input" list="productosList" autocomplete="off" />
              <datalist id="productosList"></datalist>
            </div>
            <div class="form-row hidden" id="row-cuotas">
              <span class="label">Nro de cuotas:</span>
              <select id="cuotas" class="input">
                <option value="" disabled selected>Selecciona la cantidad de cuotas</option>
              </select>
            </div>
            <div class="form-row" id="row-valor">
              <span class="label">Valor:</span>
              <input id="valor" class="input" />
            </div>
            <div class="form-row hidden" id="row-inicio">
              <span class="label">Inicio plataforma:</span>
              <div class="inicio-container" style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                <select id="inicioTipo" class="input">
                  <option value="" disabled selected>Selecciona el tipo de inicio</option>
                  <option value="primer-pago">Con primer pago</option>
                  <option value="fecha-personalizada">Fecha personalizada</option>
                </select>
                <input type="date" id="inicio" class="input" style="display: none;" />
              </div>
            </div>
            <div class="form-row hidden" id="row-fecha-max">
              <span class="label">Fecha m√°xima:</span>
              <input
                type="date"
                id="fechaMax"
                class="input"
                placeholder="Indica hasta qu√© d√≠a estar√° disponible el link de pago"
              />
            </div>
            <div class="form-row" id="row-comercial">
              <span class="label">Comercial:</span>
              <select id="comercial" class="input">
                <option value="" disabled selected>Selecciona tu nombre</option>
                <option>√Ålex David L√≥pez Jaramillo</option>
                <option>Ana Isabel Arango Goez</option>
                <option>√Ångela Yirley Silva David</option>
                <option>Ang√©lica Sol√≥rzano Torres</option>
                <option>Daniel Mauricio Cardona Alzate</option>
                <option>Eliana Marcela Montilla De La Cruz</option>
                <option>Giancarlo Aguilar Fonnegra</option>
                <option>Santiago Fl√≥rez Rojo</option>
              </select>
            </div>
            <!-- Plan de pagos -->
            <div id="planPagosContainer" class="hidden">
              <h3 style="margin-top: 20px; color: #075183;">Plan de pagos</h3>
              <table id="planPagosTable">
                <thead>
                  <tr>
                    <th>Nro de cuota</th>
                    <th>Fecha</th>
                    <th>Valor cuota</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <!-- Bot√≥n Crear link debajo del Plan de pagos -->
            <div class="form-row hidden" id="row-link-btn">
              <button id="createLinkBtn" class="input">Crear link</button>
            </div>
            <div id="linkResult" style="margin-top:8px;"></div>
          </div>

          <!-- VENTA EN CONFIANZA (DERECHA) -->
          <div class="venta-confianza-section">
            <h3 style="margin-top: 0; margin-bottom: 20px;">Venta en confianza</h3>
            <div class="form-row">
              <span class="label">Nombres:</span>
              <input id="nombresConfianza" class="input gray"/>
            </div>
            <div class="form-row">
              <span class="label">Apellidos:</span>
              <input id="apellidosConfianza" class="input gray"/>
            </div>
            <div class="form-row">
              <span class="label">Correo:</span>
              <input id="correoConfianza" class="input" readonly style="background-color: #f5f5f5; cursor: not-allowed;" title="Campo autom√°tico: se alimenta de datos del sistema" />
            </div>
            <div class="form-row">
              <span class="label">Celular:</span>
              <input id="celularConfianza" class="input" readonly style="background-color: #f5f5f5; cursor: not-allowed;" title="Campo autom√°tico: se alimenta de datos del sistema" />
            </div>
            <div class="form-row">
              <span class="label">Nro Acuerdo:</span>
              <div style="display: flex; gap: 8px;">
                <input id="nroAcuerdo" class="input" placeholder="Ingrese n√∫mero de acuerdo" autocomplete="new-password" />
                <button id="buscarAcuerdoBtn">üîç Buscar acuerdo</button>
              </div>
            </div>

            <!-- Campos deshabilitados que se poblar√°n con la consulta del acuerdo -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
              <div class="form-row">
                <span class="label">Producto:</span>
                <input id="productoAcuerdo" class="input" disabled style="background-color: #f5f5f5;"/>
              </div>
              <div class="form-row">
                <span class="label">Comercial:</span>
                <input id="comercialAcuerdo" class="input" disabled style="background-color: #f5f5f5;"/>
              </div>
              <div class="form-row">
                <span class="label">Fecha inicio:</span>
                <input id="fechaInicioAcuerdo" class="input" disabled style="background-color: #f5f5f5;"/>
              </div>
              <div class="form-row">
                <span class="label">Estado:</span>
                <input id="estadoAcuerdo" class="input" disabled style="background-color: #f5f5f5;"/>
              </div>
              <!-- Bot√≥n Otorgar acceso en confianza -->
              <button id="otorgarAccesoBtn">ü§ù Otorgar acceso en confianza</button>

              <!-- Campo URL de activaci√≥n (inicialmente oculto) -->
              <div id="urlActivacionSection" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <div class="form-row">
                  <span class="label">URL de activaci√≥n:</span>
                  <div style="display: flex; gap: 8px;">
                    <input id="urlActivacion" class="input" disabled style="background-color: #f5f5f5; flex: 1;" placeholder="Se generar√° autom√°ticamente tras el registro exitoso"/>
                    <button id="copiarUrlBtn" disabled style="white-space: nowrap;">üìã Copiar</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- OTRAS PESTA√ëAS -->
      <div class="pane right" id="membresias">
      <div class="memb-layout">
        <!-- IZQUIERDA: Plataforma vieja -->
        <div class="memb-old">
          <h3 style="margin-top: 20px; color: #075183;">Plataforma vieja</h3>
          <div id="membOldContainer"></div>
        </div>

        <!-- CENTRO: FRAPP -->
        <div class="memb-new">
          <div class="memb-new-header" style="display:flex;align-items:center;justify-content:flex-start;margin-bottom:8px">
            <h3 style="margin-top: 20px; color: #075183;">Plataforma nueva</h3>
          </div>
          <div id="membNewContainer"></div>
          <div style="margin-top:12px;">
            <button id="addMembBtn" style="padding:6px 12px;font-size:1em;cursor:pointer;">
              ‚ûï Agregar plan
            </button>
          </div>
        </div>

        <!-- DERECHA: Acciones (estrecha) -->
        <div class="memb-actions">
          <h3 style="margin-top: 20px; color: #075183;">Acciones</h3>
          <button id="batchOpenBtn" class="batch-btn" title="Agregar planes en lote">
            ‚ûï‚ûï Agregar planes<br>en lote
          </button>
          <!-- aqu√≠ en el futuro puedes sumar m√°s botones/acciones -->
        </div>
      </div>

      <div id="membresiasContainer"></div>
    </div>
      <div class="pane right" id="ventas">
        <div id="ventasContainer"></div>
        <div id="discountAnalysis" style="margin-top:16px"></div>
      </div>
      <div class="pane right" id="acuerdos">
        <div id="acuerdosContainer"></div>
      </div>
      <div class="pane right" id="links">
        <h3 id="linksTitle" style="display:none">Links</h3>
        <div id="linksContainer"></div>
      </div>

      <!-- WEB PIG -->
      <div class="pane right" id="webpig">
        <div class="webpig-fixed-header">
          <div class="webpig-header">
            <h3 id="webpigTitle">Web Pig üê∑ - Transacciones Recientes</h3>
            <button id="refreshWebhooksBtn" class="btn-primary">üîÑ Actualizar transacciones</button>
          </div>
          <div class="webpig-controls">
            <div class="feature-flags-container">
              <div class="feature-flag-item">
                <span class="flag-label">Crear membres√≠as</span>
                <label class="toggle-switch">
                  <input type="checkbox" id="flag-MEMBERSHIPS_ENABLED" data-flag="MEMBERSHIPS_ENABLED" disabled>
                  <span class="slider"></span>
                </label>
              </div>
              <div class="feature-flag-item">
                <span class="flag-label">Facturar</span>
                <label class="toggle-switch">
                  <input type="checkbox" id="flag-WORLDOFFICE_INVOICE_ENABLED" data-flag="WORLDOFFICE_INVOICE_ENABLED" disabled>
                  <span class="slider"></span>
                </label>
              </div>
              <div class="feature-flag-item">
                <span class="flag-label">Emitir DIAN</span>
                <label class="toggle-switch">
                  <input type="checkbox" id="flag-WORLDOFFICE_DIAN_ENABLED" data-flag="WORLDOFFICE_DIAN_ENABLED" disabled>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            <div id="flagsErrorMsg" class="flags-error-msg" style="display: none;"></div>
          </div>
        </div>
        <div id="webpigContainer"></div>
      </div>

      <!-- UDEA2026 -->
      <div class="pane right" id="udea2026">
        <h2>Udea2026</h2>
        <p>Contenido de Udea2026</p>
      </div>
    </div>
  </div>

  <!-- ====== Modal para "Agregar plan" ====== -->
  <div id="addMembModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog">
      <h3>‚ûï Agregar plan</h3>
      <div id="modalResponse" class="modal-response" style="margin-bottom:12px;color:#333;display:none;"></div>
      <form id="addMembForm">
        <!-- Email -->
        <div class="modal-row">
          <label for="modalEmail">Correo</label>
          <input type="email" id="modalEmail" required />
        </div>
        <!-- Nombres -->
        <div class="modal-row">
          <label for="modalGiven">Nombres</label>
          <input type="text" id="modalGiven" required />
        </div>
        <!-- Apellidos -->
        <div class="modal-row">
          <label for="modalFamily">Apellidos</label>
          <input type="text" id="modalFamily" required />
        </div>
        <!-- Celular -->
        <div class="modal-row">
          <label for="modalPhone">Celular</label>
          <input type="tel" id="modalPhone" required />
        </div>
        <div class="modal-row">
          <label for="modalEvento">Justificaci√≥n</label>
          <textarea id="modalEvento" required rows="2"></textarea>
        </div>
        <!-- Plan -->
        <div class="modal-row">
          <label for="modalHandle">Plan</label>
          <select id="modalHandle" required>
            <option value="" disabled selected>Cargando planes...</option>
          </select>
        </div>
        <!-- Fecha inicio -->
        <div class="modal-row">
          <label for="modalStart">Fecha inicio</label>
          <input type="date" id="modalStart" required />
        </div>
        <!-- Duraci√≥n (d√≠as) -->
        <div class="modal-row">
          <label for="modalDuration">Duraci√≥n (d√≠as)</label>
          <input type="number" id="modalDuration" min="1" required />
        </div>
        <!-- Fecha fin -->
        <div class="modal-row">
          <label for="modalExpiry">Fecha fin</label>
          <input type="date" id="modalExpiry" required />
        </div>
        <!-- Botones -->
        <div class="modal-actions">
          <button type="button" id="cancelAddMemb">‚ùå Cancelar</button>
          <button type="submit">‚úÖ Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para Congelar membres√≠a -->
  <div id="freezeModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog">
      <h3>ü•∂ Congelar membres√≠a</h3>
      <form id="freezeForm">
        <div class="modal-row">
          <label for="freezeReason">Motivo</label>
          <input type="text" id="freezeReason" required />
        </div>
        <div class="modal-row">
          <label for="freezeDate">Desde</label>
          <input type="date" id="freezeDate" required />
        </div>
        <div class="modal-row">
          <label for="unfreezeDate">Hasta</label>
          <input type="date" id="unfreezeDate" required />
        </div>
        <div class="modal-row">
          <label for="daysRemaining">D√≠as restantes</label>
          <input type="number" id="daysRemaining" readonly />
        </div>
        <div class="modal-actions">
          <button type="button" id="cancelFreeze">‚ùå Cancelar</button>
          <button type="submit">ü•∂ Congelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n -->
  <div id="freezeSuccessModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog">
      <h3>‚úÖ Congelaci√≥n exitosa</h3>
      <div class="modal-actions">
        <button id="closeFreezeSuccess">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Agregar planes en lote -->
    <div id="batchModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-dialog" style="width:900px;max-width:95vw">
        <h3>‚ûï‚ûï Agregar planes en lote</h3>

        <!-- Plan -->
        <div class="modal-row">
          <label for="batchProduct">Plan</label>
          <select id="batchProduct" required>
            <option value="" disabled selected>Cargando planes...</option>
          </select>
        </div>

        <!-- Fecha inicio -->
        <div class="modal-row">
          <label for="batchStart">Fecha inicio</label>
          <input type="date" id="batchStart" required />
        </div>

        <!-- Duraci√≥n (d√≠as) -->
        <div class="modal-row">
          <label for="batchDuration">Duraci√≥n (d√≠as)</label>
          <input type="number" id="batchDuration" min="1" required />
        </div>

        <!-- Fecha fin -->
        <div class="modal-row">
          <label for="batchExpiry">Fecha fin</label>
          <input type="date" id="batchExpiry" required />
        </div>

        <div class="batch-grid">
          <div class="batch-col">
            <label><strong>C√©dulas</strong></label>
            <textarea id="batchCedulas" placeholder="Una c√©dula por l√≠nea"></textarea>
            <div class="mini">Se ignorar√°n duplicados y caracteres no num√©ricos.</div>
          </div>
          <div class="batch-col">
            <button id="batchValidateBtn">üìß Validar emails</button>
            <div id="batchResults" class="box" aria-live="polite">
              <ul id="batchResultsList" class="pair-list"></ul>
            </div>
          </div>
          <div class="batch-col">
            <button id="batchAddBtn">‚ûï‚ûï Agregar planes</button>
            <button id="batchPauseBtn" disabled>‚è∏Ô∏è Pausar</button>
            <div id="batchAddStatus" class="box" aria-live="polite">
              <ul id="batchAddList" class="pair-list"></ul>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" id="batchCloseBtn">Cerrar</button>
        </div>
      </div>
    </div>

  <!-- ====== Modal para detalles de Stage (Web Pig) ====== -->
  <div id="stageDetailsModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content" style="max-width: 800px;">
      <h2 id="stageDetailsTitle">Detalles del Stage</h2>
      <div id="stageDetailsBody" style="max-height: 500px; overflow-y: auto;">
        <!-- Content will be populated by JavaScript -->
      </div>
      <div class="modal-actions">
        <button type="button" id="stageDetailsCloseBtn">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Include the JavaScript files -->
  <script>
    // Pass server-side variables to client-side JavaScript
    const USER_EMAIL = '<%= typeof userEmail !== "undefined" ? userEmail : "" %>';
  </script>
  <!-- API Client (loads first) -->
  <script src="/js/api-client.js"></script>
  <!-- Navigation fix -->
  <script src="/js/navigation-fix.js"></script>
  <!-- Main application JavaScript -->
  <script src="/js/app.js"></script>
  <!-- Web Pig module -->
  <script src="/js/webpig.js"></script>
</body>
</html>
